disableSave = false
buttonFontColor = {0, 0, 0}
buttonColor = {0.93, 0.88, 0.82}
buttonScale = {0.1, 0.1, 0.1}
defaultButtonData = {
    textbox = {
        {
            pos = {0.906, 0.1, -2.14},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -2.028},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.916},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.804},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.692},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.580},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.468},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.356},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.244},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.132},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -1.020},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.908},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.796},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.684},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.572},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.460},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.348},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.236},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.124},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, -0.012},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.100},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.212},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.324},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.436},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.548},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.660},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.772},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.884},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 0.996},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.108},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.220},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.332},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.444},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.556},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.668},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.780},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 1.892},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 2.004},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 2.116},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        },
        {
            pos = {0.906, 0.1, 2.228},
            rows = 2,
            width = 5300,
            font_size = 250,
            label = "",
            value = "",
            alignment = 2
        }
    }
}
function updateSave()
    saved_data = JSON.encode(ref_buttonData)
    if disableSave == true then
        saved_data = ""
    end
    self.script_state = saved_data
end
function onload(saved_data)
    self.interactable = true
    if disableSave == true then
        saved_data = ""
    end
    if saved_data ~= "" then
        local loaded_data = JSON.decode(saved_data)
        ref_buttonData = loaded_data
    else
        ref_buttonData = defaultButtonData
    end

    self.createButton(
        {
            click_function = "order_initiative",
            function_owner = self,
            label = "Order",
            position = {x = 0.2, y = 0.1, z = -2.35},
            rotation = {0, 0, 0},
            width = 350,
            height = 100,
            font_size = 100,
            color = {112 / 255, 0, 8 / 255},
            font_color = {232 / 255, 222 / 255, 197 / 255},
            tooltip = "Order Initiative Tokens",
            scale = {x = 0.5, y = 0.1, z = 0.5}
        }
    )

    spawnedButtonCount = 0
    createTextbox()
end
function click_textbox(i, value, selected)
    if selected == false then
        ref_buttonData.textbox[i].value = value
        updateSave()
    end
end
function click_none()
end
function createTextbox()
    for i, data in ipairs(ref_buttonData.textbox) do
        local funcName = "textbox" .. i
        local func = function(_, _, val, sel)
            click_textbox(i, val, sel)
        end
        self.setVar(funcName, func)

        self.createInput(
            {
                input_function = funcName,
                function_owner = self,
                label = data.label,
                alignment = data.alignment,
                position = data.pos,
                scale = buttonScale,
                width = data.width,
                height = (data.font_size * data.rows) + 24,
                font_size = data.font_size,
                color = buttonColor,
                font_color = buttonFontColor,
                value = data.value
            }
        )
    end
end

local _initiativeTokens = {}

local _difference = 0.754
local _initiativeZone = "6befe7"
local _tokenName = {"player_token", "enemy_token", "ally_token", "neutral_token"}

function order_initiative(obj, color, alt)
    _initiativeTokens = {}
    local zone = getObjectFromGUID(_initiativeZone)
    local objs = zone.getObjects()
    for i = 0, #objs do
        local obj = objs[i]
        if obj then
            local name = obj.getName()
            if isToken(name) then
                local tt = getLines(obj.getInputs()[1].value)
                local ini = tonumber(tt[2])
                local nn = tt[1]
                table.insert(_initiativeTokens, {token = obj, initiative = ini, name = nn})
            --print(ini .. n)
            end
        end
    end

    table.sort(
        _initiativeTokens,
        function(k1, k2)
            return k1.initiative > k2.initiative
        end
    )
    local pos = {x = 101.86, y = 3.04, z = -31.76}

    for i = 0, #_initiativeTokens do
        local t = _initiativeTokens[i]
        pos.y = math.random(3.1, 5)
        if t then
            t.token.setPositionSmooth(pos, false, false)
            t.token.setRotationSmooth({0, 90, 0}, false, true)
            pos.x = pos.x + _difference
        end
    end

    sendToGlobal(_initiativeTokens)
end

function sendToGlobal(objs)
    local elements = {}

    for i = 1, #objs do
        local element = {
            ini = nil,
            name = nil,
            side = nil,
            pawn = nil
        }
        local pawn = getLines(objs[i].token.getDescription())[4]
        if pawn then
            element.pawn = pawn
        else
            element.pawn = nil
        end

        element.ini = objs[i].initiative
        element.name = objs[i].name

        local color = objs[i].token.getColorTint()
        local side = mysplit(objs[i].token.getName(), "_")[1]
        element.side = side
        table.insert(elements, element)
    end
    Global.Call("setElements", {t = elements})
end

function isToken(name)
    for i = 0, #_tokenName do
        if name == _tokenName[i] then
            return true
        end
    end
    return false
end

function getLines(text)
    local returner = {}
    for s in text:gmatch("[^\r\n]+") do
        table.insert(returner, s)
    end
    return returner
end

function printTable(t)
    local printTable_cache = {}

    local function sub_printTable(t, indent)
        if (printTable_cache[tostring(t)]) then
            print(indent .. "*" .. tostring(t))
        else
            printTable_cache[tostring(t)] = true
            if (type(t) == "table") then
                for pos, val in pairs(t) do
                    if (type(val) == "table") then
                        print(indent .. "[" .. pos .. "] => " .. tostring(t) .. " {")
                        sub_printTable(val, indent .. string.rep(" ", string.len(pos) + 8))
                        print(indent .. string.rep(" ", string.len(pos) + 6) .. "}")
                    elseif (type(val) == "string") then
                        print(indent .. "[" .. pos .. '] => "' .. val .. '"')
                    else
                        print(indent .. "[" .. pos .. "] => " .. tostring(val))
                    end
                end
            else
                print(indent .. tostring(t))
            end
        end
    end

    if (type(t) == "table") then
        print(tostring(t) .. " {")
        sub_printTable(t, "  ")
        print("}")
    else
        sub_printTable(t, "  ")
    end
end

function mysplit(inputstr, sep)
    if sep == nil then
        sep = "%s"
    end
    local t = {}
    i = 1
    for str in string.gmatch(inputstr, "([^" .. sep .. "]+)") do
        t[i] = str
        i = i + 1
    end
    return t
end
